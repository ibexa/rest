parameters:
    ezpublish_rest.routing.options_loader.class: Ibexa\Bundle\Rest\Routing\OptionsLoader
    ezpublish_rest.routing.options_loader.route_collection_mapper.class: Ibexa\Bundle\Rest\Routing\OptionsLoader\RouteCollectionMapper
    ezpublish_rest.routing.options_loader.mapper.class: Ibexa\Bundle\Rest\Routing\OptionsLoader\Mapper

    ezpublish_rest.cors_options_provider.class: Ibexa\Bundle\Rest\CorsOptions\RestProvider

    ezpublish_rest.root_resource_builder.class: Ibexa\Rest\Server\Service\ExpressionRouterRootResourceBuilder

    ezpublish_rest.controller.base.class: Ibexa\Rest\Server\Controller
    ezpublish_rest.controller.binary_content.class: Ibexa\Rest\Server\Controller\BinaryContent
    ezpublish_rest.controller.content.class: Ibexa\Rest\Server\Controller\Content
    ezpublish_rest.controller.content_type.class: Ibexa\Rest\Server\Controller\ContentType
    ezpublish_rest.controller.location.class: Ibexa\Rest\Server\Controller\Location
    ezpublish_rest.controller.object_state.class: Ibexa\Rest\Server\Controller\ObjectState
    ezpublish_rest.controller.role.class: Ibexa\Rest\Server\Controller\Role
    ezpublish_rest.controller.root.class: Ibexa\Rest\Server\Controller\Root
    ezpublish_rest.controller.section.class: Ibexa\Rest\Server\Controller\Section
    ezpublish_rest.controller.trash.class: Ibexa\Rest\Server\Controller\Trash
    ezpublish_rest.controller.user.class: Ibexa\Rest\Server\Controller\User
    ezpublish_rest.controller.url_wildcard.class: Ibexa\Rest\Server\Controller\URLWildcard
    ezpublish_rest.controller.url_alias.class: Ibexa\Rest\Server\Controller\URLAlias
    ezpublish_rest.controller.options.class: Ibexa\Rest\Server\Controller\Options
    ezpublish_rest.controller.services.class: Ibexa\Rest\Server\Controller\Services
    ezpublish_rest.controller.views.class: Ibexa\Rest\Server\Controller\Views

    ezpublish_rest.factory.class: Ibexa\Bundle\Rest\ApiLoader\Factory
    ezpublish_rest.request_parser.class: Ibexa\Bundle\Rest\RequestParser\Router
    ezpublish_rest.parser_tools.class: Ibexa\Rest\Input\ParserTools
    ezpublish_rest.field_type_parser.class: Ibexa\Rest\Input\FieldTypeParser
    ezpublish_rest.field_type_serializer.class: Ibexa\Rest\Output\FieldTypeSerializer

    ezpublish_rest.request_listener.class: Ibexa\Bundle\Rest\EventListener\RequestListener
    ezpublish_rest.csrf_listener.class: Ibexa\Bundle\Rest\EventListener\CsrfListener
    ezpublish_rest.response_listener.class: Ibexa\Bundle\Rest\EventListener\ResponseListener

    ezpublish_rest.field_type_processor.ezauthor.class: Ibexa\Rest\FieldTypeProcessor\AuthorProcessor
    ezpublish_rest.field_type_processor_registry.class: Ibexa\Rest\FieldTypeProcessorRegistry
    ezpublish_rest.field_type_processor.ezimage.class: Ibexa\Rest\FieldTypeProcessor\ImageProcessor
    ezpublish_rest.field_type_processor.ezdatetime.class: Ibexa\Rest\FieldTypeProcessor\DateAndTimeProcessor
    ezpublish_rest.field_type_processor.ezdate.class: Ibexa\Rest\FieldTypeProcessor\DateProcessor
    ezpublish_rest.field_type_processor.ezmedia.class: Ibexa\Rest\FieldTypeProcessor\MediaProcessor
    ezpublish_rest.field_type_processor.ezobjectrelationlist.class: Ibexa\Rest\FieldTypeProcessor\RelationListProcessor
    ezpublish_rest.field_type_processor.ezobjectrelation.class: Ibexa\Rest\FieldTypeProcessor\RelationProcessor
    ezpublish_rest.field_type_processor.eztime.class: Ibexa\Rest\FieldTypeProcessor\TimeProcessor
    ezpublish_rest.field_type_processor.ezbinaryfile.class: Ibexa\Rest\FieldTypeProcessor\BinaryProcessor
    ezpublish_rest.field_type_processor.ezfloat.class: Ibexa\Rest\FieldTypeProcessor\FloatProcessor
    ezpublish_rest.field_type_processor.ezstring.class: Ibexa\Rest\FieldTypeProcessor\StringProcessor
    ezpublish_rest.field_type_processor.ezuser.class: Ibexa\Rest\FieldTypeProcessor\UserProcessor

    ezpublish_rest.output.visitor.dispatcher.class: Ibexa\Rest\Server\View\AcceptHeaderVisitorDispatcher
    ezpublish_rest.output.visitor.class: Ibexa\Contracts\Rest\Output\Visitor
    ezpublish_rest.output.generator.json.class: Ibexa\Rest\Output\Generator\Json
    ezpublish_rest.output.generator.json.field_type_hash_generator.class: Ibexa\Rest\Output\Generator\Json\FieldTypeHashGenerator
    ezpublish_rest.output.generator.xml.class: Ibexa\Rest\Output\Generator\Xml
    ezpublish_rest.output.generator.xml.field_type_hash_generator.class: Ibexa\Rest\Output\Generator\Xml\FieldTypeHashGenerator
    ezpublish_rest.output.visitor.json.regexps:
        - '(^application/vnd\.ez\.api\.[A-Za-z]+\+json$)'
        - '(^application/json$)'
    ezpublish_rest.output.visitor.xml.regexps:
        - '(^application/vnd\.ez\.api\.[A-Za-z]+\+xml$)'
        - '(^application/xml$)'
        - '(^.*/.*$)'

    ezpublish_rest.output.value_object_visitor.dispatcher.class: Ibexa\Contracts\Rest\Output\ValueObjectVisitorDispatcher
    ezpublish_rest.output.value_object_visitor.Exception.InvalidArgumentException.class: Ibexa\Rest\Server\Output\ValueObjectVisitor\InvalidArgumentException

    ezpublish_rest.input.dispatcher.class: Ibexa\Rest\Input\Dispatcher
    ezpublish_rest.input.parsing_dispatcher.class: Ibexa\Contracts\Rest\Input\ParsingDispatcher

    ezpublish_rest.input.handler.json.class: Ibexa\Rest\Input\Handler\Json
    ezpublish_rest.input.handler.xml.class: Ibexa\Rest\Input\Handler\Xml

services:
    ezpublish_rest.routing.options_loader:
        class: "%ezpublish_rest.routing.options_loader.class%"
        arguments:
            - "@ezpublish_rest.routing.options_loader.route_collection_mapper"
            - "@ezpublish_rest.templated_router"
        tags:
            - { name: routing.loader }

    ezpublish_rest.routing.options_loader.route_collection_mapper:
        class: "%ezpublish_rest.routing.options_loader.route_collection_mapper.class%"
        arguments:
            - "@ezpublish_rest.routing.options_loader.mapper"

    ezpublish_rest.routing.options_loader.mapper:
        class: "%ezpublish_rest.routing.options_loader.mapper.class%"

    ezpublish_rest.cors_option_provider:
        class: "%ezpublish_rest.cors_options_provider.class%"
        arguments: ["@router.default"]
        tags:
            - { name: nelmio_cors.options_provider }

    ezpublish_rest.field_type_serializer:
        class: "%ezpublish_rest.field_type_serializer.class%"
        arguments:
            - "@ezpublish.api.service.field_type"
            - "@ezpublish_rest.field_type_processor_registry"

    ezpublish_rest.request_parser:
        class: "%ezpublish_rest.request_parser.class%"
        arguments:
            - "@router"

    ezpublish_rest.parser_tools:
        class: "%ezpublish_rest.parser_tools.class%"

    ezpublish_rest.field_type_parser:
        class: "%ezpublish_rest.field_type_parser.class%"
        arguments:
            - "@ezpublish.api.service.content"
            - "@ezpublish.api.service.content_type"
            - "@ezpublish.api.service.field_type"
            - "@ezpublish_rest.field_type_processor_registry"

    ezpublish_rest.factory:
        class: "%ezpublish_rest.factory.class%"
        arguments: ["@ezpublish.config.resolver", "@ezpublish.api.repository"]
        calls:
            - [setRequestStack, ["@request_stack"]]

    ezpublish_rest.root_resource_builder:
         class: "%ezpublish_rest.root_resource_builder.class%"
         arguments: ["@router", "@ezpublish_rest.templated_router", "@ezpublish.config.resolver"]

    ezpublish_rest.controller.base:
        class: "%ezpublish_rest.controller.base.class%"
        calls:
            - [ setContainer, ["@service_container"] ]
            - [ setInputDispatcher, ["@ezpublish_rest.input.dispatcher"] ]
            - [ setRouter, ["@router"] ]
            - [ setRequestParser, ["@ezpublish_rest.request_parser"] ]
            - [ setRepository, ["@ezpublish.api.repository"] ]

    ezpublish_rest.controller.root:
        class: "%ezpublish_rest.controller.root.class%"
        parent: ezpublish_rest.controller.base
        arguments: ["@ezpublish_rest.root_resource_builder"]
        tags: [controller.service_arguments]

    ezpublish_rest.controller.section:
        class: "%ezpublish_rest.controller.section.class%"
        parent: ezpublish_rest.controller.base
        arguments:
            - "@ezpublish.api.service.section"
        tags: [controller.service_arguments]

    ezpublish_rest.controller.binary_content:
        class: "%ezpublish_rest.controller.binary_content.class%"
        parent: ezpublish_rest.controller.base
        arguments:
            - "@ezpublish.fieldType.ezimage.variation_service"
            - '@ezpublish.config.resolver'
        tags: [controller.service_arguments]

    ezpublish_rest.controller.content:
        class: "%ezpublish_rest.controller.content.class%"
        parent: ezpublish_rest.controller.base
        tags: [controller.service_arguments]

    ezpublish_rest.controller.content_type:
        class: "%ezpublish_rest.controller.content_type.class%"
        parent: ezpublish_rest.controller.base
        arguments:
            - "@ezpublish.api.service.content_type"
        tags: [controller.service_arguments]

    ezpublish_rest.controller.role:
        class: "%ezpublish_rest.controller.role.class%"
        parent: ezpublish_rest.controller.base
        arguments:
            - "@ezpublish.api.service.role"
            - "@ezpublish.api.service.user"
            - "@ezpublish.api.service.location"
        tags: [controller.service_arguments]

    ezpublish_rest.controller.location:
        class: "%ezpublish_rest.controller.location.class%"
        parent: ezpublish_rest.controller.base
        arguments:
            - "@ezpublish.api.service.location"
            - "@ezpublish.api.service.content"
            - "@ezpublish.api.service.trash"
            - "@ezpublish.api.service.url_alias"
        tags: [controller.service_arguments]

    ezpublish_rest.controller.object_state:
        class: "%ezpublish_rest.controller.object_state.class%"
        parent: ezpublish_rest.controller.base
        arguments:
            - "@ezpublish.api.service.object_state"
            - "@ezpublish.api.service.content"
        tags: [controller.service_arguments]

    ezpublish_rest.controller.trash:
        class: "%ezpublish_rest.controller.trash.class%"
        parent: ezpublish_rest.controller.base
        arguments:
            - "@ezpublish.api.service.trash"
            - "@ezpublish.api.service.location"
        tags: [controller.service_arguments]

    ezpublish_rest.controller.user:
        class: "%ezpublish_rest.controller.user.class%"
        parent: ezpublish_rest.controller.base
        arguments:
            - "@ezpublish.api.service.user"
            - "@ezpublish.api.service.role"
            - "@ezpublish.api.service.content"
            - "@ezpublish.api.service.content_type"
            - "@ezpublish.api.service.location"
            - "@ezpublish.api.service.section"
            - "@ezpublish.api.repository"
            - '@Ibexa\Contracts\Core\Repository\PermissionResolver'
        tags: [controller.service_arguments]

    ezpublish_rest.controller.url_wildcard:
        class: "%ezpublish_rest.controller.url_wildcard.class%"
        parent: ezpublish_rest.controller.base
        arguments:
            - "@ezpublish.api.service.url_wildcard"
        tags: [controller.service_arguments]

    ezpublish_rest.controller.url_alias:
        class: "%ezpublish_rest.controller.url_alias.class%"
        parent: ezpublish_rest.controller.base
        arguments:
            - "@ezpublish.api.service.url_alias"
            - "@ezpublish.api.service.location"
        tags: [controller.service_arguments]

    ezpublish_rest.controller.views:
        class: "%ezpublish_rest.controller.views.class%"
        parent: ezpublish_rest.controller.base
        arguments:
            - "@ezpublish.api.service.search"
        tags: [controller.service_arguments]

    ezpublish_rest.controller.session:
        class: Ibexa\Rest\Server\Controller\SessionController
        parent: ezpublish_rest.controller.base
        arguments:
            - "%ezpublish_rest.csrf_token_intention%"
            - '@Ibexa\Contracts\Core\Repository\PermissionResolver'
            - '@ezpublish.api.service.user'
            - "@?ezpublish_rest.session_authenticator"
            - "@?ezpublish_rest.security.csrf.token_manager"
        tags: [controller.service_arguments]

    ezpublish_rest.controller.bookmark:
        class: Ibexa\Rest\Server\Controller\Bookmark
        parent: ezpublish_rest.controller.base
        arguments:
            - '@ezpublish.api.service.bookmark'
            - '@ezpublish.api.service.location'
        tags: [controller.service_arguments]

    Ibexa\Rest\Server\Controller\JWT:
        parent: ezpublish_rest.controller.base
        arguments:
            - '@Lexik\Bundle\JWTAuthenticationBundle\Services\JWTTokenManagerInterface'
            - '@?ezpublish_rest.session_authenticator'
        tags: [controller.service_arguments]

    ezpublish_rest.request_listener:
        class: "%ezpublish_rest.request_listener.class%"
        tags:
            - { name: kernel.event_subscriber }

    ezpublish_rest.response_listener:
        class: "%ezpublish_rest.response_listener.class%"
        arguments:
            - "@ezpublish_rest.output.visitor.dispatcher"
        tags:
            - { name: kernel.event_subscriber }

    ezpublish_rest.csrf_listener:
        class: "%ezpublish_rest.csrf_listener.class%"
        arguments:
            - "@event_dispatcher"
            - "%form.type_extension.csrf.enabled%"
            - "%ezpublish_rest.csrf_token_intention%"
            - "@?ezpublish_rest.security.csrf.token_manager"
        tags:
            - { name: kernel.event_subscriber }

    ezpublish_rest.controller.options:
        class: "%ezpublish_rest.controller.options.class%"
        parent: ezpublish_rest.controller.base
        tags: [controller.service_arguments]

    ezpublish_rest.controller.services:
        class: "%ezpublish_rest.controller.services.class%"
        arguments: ["%ezpublish.fieldType.ezcountry.data%"]
        tags: [controller.service_arguments]

    ezpublish_rest.field_type_processor_registry:
        class: "%ezpublish_rest.field_type_processor_registry.class%"
        lazy: true

    ezpublish_rest.field_type_processor.ezimage:
        class: "%ezpublish_rest.field_type_processor.ezimage.class%"
        factory: ["@ezpublish_rest.factory", getImageFieldTypeProcessor]
        arguments:
            - "@router"
        tags:
            - { name: ibexa.rest.field_type.processor, alias: ezimage }

    Ibexa\Rest\FieldTypeProcessor\ImageAssetFieldTypeProcessor:
        factory: ["@ezpublish_rest.factory", getImageAssetFieldTypeProcessor]
        arguments:
            - "@router"
        tags:
            - { name: ibexa.rest.field_type.processor, alias: ezimageasset }

    ezpublish_rest.field_type_processor.ezdatetime:
        class: "%ezpublish_rest.field_type_processor.ezdatetime.class%"
        tags:
            - { name: ibexa.rest.field_type.processor, alias: ezdatetime }

    ezpublish_rest.field_type_processor.ezdate:
        class: "%ezpublish_rest.field_type_processor.ezdate.class%"
        tags:
            - { name: ibexa.rest.field_type.processor, alias: ezdate }

    ezpublish_rest.field_type_processor.ezmedia:
        class: "%ezpublish_rest.field_type_processor.ezmedia.class%"
        factory: ["@ezpublish_rest.factory", getMediaFieldTypeProcessor]
        tags:
            - { name: ibexa.rest.field_type.processor, alias: ezmedia }

    ezpublish_rest.field_type_processor.ezobjectrelationlist:
        class: "%ezpublish_rest.field_type_processor.ezobjectrelationlist.class%"
        tags:
            - { name: ibexa.rest.field_type.processor, alias: ezobjectrelationlist }
        calls:
            - [setRouter, ["@router"]]
            - [setLocationService, ["@ezpublish.api.service.location"]]

    ezpublish_rest.field_type_processor.ezobjectrelation:
        class: "%ezpublish_rest.field_type_processor.ezobjectrelation.class%"
        tags:
            - { name: ibexa.rest.field_type.processor, alias: ezobjectrelation }
        calls:
            - [setRouter, ["@router"]]
            - [setLocationService, ["@ezpublish.api.service.location"]]

    ezpublish_rest.field_type_processor.eztime:
        class: "%ezpublish_rest.field_type_processor.eztime.class%"
        tags:
            - { name: ibexa.rest.field_type.processor, alias: eztime }

    ezpublish_rest.field_type_processor.ezbinaryfile:
        class: "%ezpublish_rest.field_type_processor.ezbinaryfile.class%"
        factory: ["@ezpublish_rest.factory", getBinaryFileFieldTypeProcessor]
        arguments:
            - "@ezpublish.core.io.default_url_decorator"
        tags:
            - { name: ibexa.rest.field_type.processor, alias: ezbinaryfile }

    ezpublish_rest.field_type_processor.ezfloat:
        class: "%ezpublish_rest.field_type_processor.ezfloat.class%"
        tags:
            - { name: ibexa.rest.field_type.processor, alias: ezfloat }

    ezpublish_rest.field_type_processor.ezstring:
        class: "%ezpublish_rest.field_type_processor.ezstring.class%"
        tags:
            - { name: ibexa.rest.field_type.processor, alias: ezstring }

    ezpublish_rest.field_type_processor.ezuser:
        class: "%ezpublish_rest.field_type_processor.ezuser.class%"
        tags:
            - { name: ibexa.rest.field_type.processor, alias: ezuser }

    ### OUTPUT

    # Main REST output dispatcher
    # Gets a <requestMatch> => output.visitor mapping with the ezpublish_rest.output.visitor tag.
    ezpublish_rest.output.visitor.dispatcher:
        class: "%ezpublish_rest.output.visitor.dispatcher.class%"

    # format output visitors
    ezpublish_rest.output.visitor.json:
        class: "%ezpublish_rest.output.visitor.class%"
        arguments:
            - "@ezpublish_rest.output.generator.json"
            - "@ezpublish_rest.output.value_object_visitor.dispatcher"
        tags:
            - { name: ezpublish_rest.output.visitor, regexps: ezpublish_rest.output.visitor.json.regexps }

    ezpublish_rest.output.visitor.xml:
        class: "%ezpublish_rest.output.visitor.class%"
        arguments:
            - "@ezpublish_rest.output.generator.xml"
            - "@ezpublish_rest.output.value_object_visitor.dispatcher"
        tags:
            - { name: ezpublish_rest.output.visitor, regexps: ezpublish_rest.output.visitor.xml.regexps }

    # format output generators
    ezpublish_rest.output.generator.xml:
        class: "%ezpublish_rest.output.generator.xml.class%"
        arguments:
            - "@ezpublish_rest.output.generator.xml.field_type_hash_generator"
        calls:
            - [ setFormatOutput, [ "%kernel.debug%" ] ]

    ezpublish_rest.output.generator.xml.field_type_hash_generator:
        class: "%ezpublish_rest.output.generator.xml.field_type_hash_generator.class%"

    ezpublish_rest.output.generator.json:
        class: "%ezpublish_rest.output.generator.json.class%"
        arguments:
            - "@ezpublish_rest.output.generator.json.field_type_hash_generator"
        calls:
            - [ setFormatOutput, [ "%kernel.debug%" ] ]

    ezpublish_rest.output.generator.json.field_type_hash_generator:
        class: "%ezpublish_rest.output.generator.json.field_type_hash_generator.class%"

    # value objects visitors
    ezpublish_rest.output.value_object_visitor.dispatcher:
        class: "%ezpublish_rest.output.value_object_visitor.dispatcher.class%"

    ezpublish_rest.output.value_object_visitor.Exception.InvalidArgumentException:
        class: "%ezpublish_rest.output.value_object_visitor.Exception.InvalidArgumentException.class%"
        tags:
            - { name: ezpublish_rest.output.value_object_visitor, type: \Ibexa\Contracts\Core\Repository\Exceptions\InvalidArgumentException }

    ezpublish_rest.input.dispatcher:
        class: "%ezpublish_rest.input.dispatcher.class%"
        arguments:
            - "@ezpublish_rest.input.parsing_dispatcher"
            - []

    ezpublish_rest.input.parsing_dispatcher:
        class: "%ezpublish_rest.input.parsing_dispatcher.class%"

    ezpublish_rest.input.handler.json:
        class: "%ezpublish_rest.input.handler.json.class%"
        tags:
            - { name: ezpublish_rest.input.handler, format: json }

    ezpublish_rest.input.handler.xml:
        class: "%ezpublish_rest.input.handler.xml.class%"
        tags:
            - { name: ezpublish_rest.input.handler, format: xml }

    ezpublish_rest.templated_router:
        class: Ibexa\Bundle\Core\Routing\DefaultRouter
        parent: hautelook.router.template
        calls:
            - [ setOption, [ strict_requirements, ~ ] ]
